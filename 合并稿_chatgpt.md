---
title: 医疗行业AIGC系统合并版技术方案（V1.0）
authors: 架构组
status: Draft
last_updated: 2025-10-20
---

# 医疗行业AIGC系统合并版技术方案（V1.0）

> 本文在三份调研成果（文档A/文档B/文档C）基础上“求同存异”收敛形成：在**共识项**上定案可落地做法，在**存异项**保留可切换路线与触发条件。可直接用作研发/架构/法务评审底稿。

- 面向对象：药企、医院、医生  
- 目标假设：多角色多需求可抽象为有限的「输入 → 处理 → 输出」模式  
- 核心模块：意图识别与分析｜工作流编排｜工具/API 调度｜任务与状态监控｜结果生成与渲染｜人工审核与编辑（HITL）  
- 方法论：可控优先｜合规先行｜可观测内建｜成本受控｜渐进私有化

---

## 0. 执行摘要（共识 & 存异）

### 共识（定案）
1. **架构**：K8s + Istio 的微服务与事件驱动（EDA）；API 网关统一鉴权与租户校验；全链路可观测（日志/指标/追踪）。  
2. **多租户**：默认 **Schema-per-tenant**；**高级合规客户 DB-per-tenant + BYOK**；核心数据域不采用行级安全（RLS）。  
3. **工作流**：**Temporal 为主**编排交互流程；**Airflow 处理批/离线**；HITL 作为 **User Task** 原生入流；流程版本化与轻量可视化（JSON/DSL）。  
4. **NLU 与路由**：两阶段（高置信 NLU→直达；低置信/模糊→LLM 澄清/判别）；不确定性作为 HITL 触发因子。  
5. **LLM**：**混合策略**（PHI/高风险本地推理；非PHI/低风险可云API），统一 **LLM Proxy** 做路由/降级/缓存；RAG 强制引注，高风险多代理复核；成本与质量双KPI。  
6. **知识**：向量库（Qdrant/Weaviate/Milvus）+ **知识图谱**（药品/疾病/指南）融合；**FHIR 治理元数据**沉淀证据、模型版本、置信度、签批链。  
7. **HITL**：前端 **Tiptap+Yjs** 协同编辑（或等价 CRDT）；电子签名、版本差异与不可篡改审计；抽检 ≥ 5%。  
8. **监控与运维**：Prometheus/Grafana + ELK + OpenTelemetry/Jaeger；AI 质量看板（准确/幻觉/审阅率）+ 成本看板（Token/GPU/调用）。

### 存异（保留切换条件）
- **工作流可视化/BPMN**：当“业务侧自助改流程的频次/人数”超过阈值时，引入 **Camunda 8（Zeebe）或 Netflix Conductor** 的可视化设计与运营面板；否则维持 Temporal + 轻量可视化。  
- **模型优先级**：若监管或数据主权要求更强（院内 PHI 全在地），提升“本地模型优先级”；在算力紧张或效果诉求极高时可扩大云API占比，但保留严格脱敏/BAA/不落盘策略。

---

## 1. 目标能力、边界与成功指标

### 能力范围
- 通用意图理解、可编排多步工具链、可追溯生成、严格合规与可解释、HITL 校验闭环、SLA/成本/质量三线监控。

### 非目标（当前阶段）
- 不提供“完全自动化诊断决策”；不替代临床最终裁量；无 EHR 写回则不进行治疗方案自动下达。

### MVP 成功指标
- 医生文书生成：**人工修改率** ≤ 35%，**首响应** ≤ 2.5s，**端到端** ≤ 60s  
- 问答质量：抽检**事实错误率** ≤ 5%，**幻觉率**（无证据断言）≤ 3%  
- 合规：**审计覆盖率** 100%，**PHI 外发事件** 0  
- 成本：**每千请求成本** 较基线下降 ≥ 20%

---

## 2. 系统架构

### 2.1 逻辑分层
- **接入层**：API 网关（OAuth2/OIDC、WAF、租户校验、配额/流控、内容风控）  
- **编排层**：Temporal（活动/工作流、重试、补偿、信号、超时、User Task）；事件总线 Kafka/Redpanda  
- **智能层**：LLM Proxy（路由/降级/语义缓存/审计）、RAG（检索/重排/引注）、判别器（事实核验/毒性/PII）  
- **工具层**：检索、结构化提取、药典/相互作用API、单位换算、表单/报告渲染、签名流转  
- **数据与知识层**：OLTP（多租户）、对象存储（文档）、向量库、知识图谱、FHIR 治理元数据仓  
- **可观测与合规**：Prometheus/Grafana、ELK、OTel/Jaeger、KMS/HSM  
- **前台**：医生/药企/管理员工作台、HITL 审核台（Tiptap+Yjs）

### 2.2 多租户与数据隔离（定案）
- **默认**：Schema-per-tenant；应用层强租户上下文校验；禁跨租户查询  
- **高保租户**：DB-per-tenant + **BYOK**；专有网络与独立审计流  
- **RLS**：核心数据域禁用；仅在边缘读场景有限使用并附二次校验

### 2.3 高可用与扩展
- 无状态服务 HPA 扩缩；长耗时异步/队列削峰；熔断与退避重试  
- 存储主从/多副本，冷热分层；同城双活 + 异地冷备（RPO/RTO 入 SLA）

### 2.4 可视化/BPMN（存异位）
- 触发条件：  
  `当 月均>10 次业务侧自助改流程请求 或 >5 位非技术编辑者 → 引入 Camunda/Conductor`  
  否则：Temporal + 轻量可视化（React Flow/JSON-DSL）

---

## 3. 意图理解与路由

### 3.1 两阶段理解
1) **NLU 层（确定性）**：分类+实体抽取（Rasa/Transformers+规则）；高置信阈值（如 ≥ 0.8）  
2) **LLM 层（弹性）**：低置信或 OOS → LLM 生成**澄清问句**或**意图候选**，并输出**不确定性分**

### 3.2 多轮对话管理
- 结构化流程：状态机/Stories；开放问答：Memory 摘要 + 工具调用  
- 话题漂移检测与上下文重置策略

### 3.3 模糊与异常
- 置信度 < 阈值 → 澄清/HITL；  
- **红旗词**（处方更改、急危重症）→ 直达 HITL；  
- “无法分类”日志 → 月度扩充意图库与训练集

---

## 4. 工作流编排

- **主引擎**：**Temporal**（活动/工作流、重试、补偿、超时、信号、User Task）  
- **批/离线**：Airflow（ETL、批量回填、索引构建）  
- **HITL**：工作流内建 **User Task**，支持暂停/提醒/超时升级  
- **版本与灰度**：工作流定义版本化；新实例走新版本，旧实例原路结束  
- **轻量可视化**：React Flow/GoJS 编辑 JSON/DSL

**存异位：可视化/BPMN/大规模可视化运营**  
- 高频业务自助改流程/强运营视图 → 引入 **Camunda 8（Zeebe）** 或 **Conductor**

---

## 5. LLM 集成与质量控制

### 5.1 模型与路由（混合）
- **数据分级路由**  
  - **PHI/高风险** → 本地私有化 7B–13B 医疗微调为主  
  - **非PHI/低风险** → 云API（签 BAA、不落盘、严格脱敏）  
- **任务分层**  
  - 结构化抽取/归一化 → 规则/小模型  
  - 一般问答/总结 → 中型本地/性价比 API  
  - 复杂推理/生成 → GPT-4/Claude 高阶  
- **LLM Proxy**：路由矩阵、熔断降级、AB 复试、语义缓存、成本打点

### 5.2 Prompt/RAG/事实核验
- **Prompt**：系统角色 + 格式模板 + few-shot；剂量/单位硬约束  
- **RAG**：向量检索 → 重排 → **强制引注**（药典/指南/文献）  
- **判别器**：事实一致性/禁词/PII 检测  
- **多代理复核**：高风险回答二次判读（LLM-as-a-judge/规则核对）

### 5.3 质量与风控 KPI
- 幻觉率、事实错误率、HITL 率、拒绝率、平均响应、P99、每千次成本  
- **自动降级**：幻觉/成本/延迟超阈 → 切换模型或强制 HITL

---

## 6. 医疗知识与标准

- **向量库**：Qdrant/Weaviate/Milvus（多租户命名空间）  
- **权威源**：药品（国家药典/DrugBank）、疾病（ICD/SNOMED）、指南（学会/权威期刊摘要）、不良反应/相互作用  
- **知识图谱**：药物-疾病-症状-禁忌关系  
- **标准化**：ICD-10/11、SNOMED CT、LOINC、RxNorm  
- **FHIR 治理元数据**：存模型名/版本、提示词摘要、证据ID、置信度、审签链、输出哈希

---

## 7. 人机协同（HITL）

- **触发**：不确定性高、红旗意图、法规要求、抽检 ≥ 5%  
- **编辑器**：**Tiptap + Yjs**（或等价 CRDT），多人协同、变更高亮、术语侧栏、模板片段  
- **签名与版本**：电子签名、全版本比对；不可篡改审计（WORM/时间戳）  
- **回流**：AI 初稿 vs 最终稿差异 → 训练库；错误类型与评分 → 提示与模型微调

---

## 8. 监控、日志与自愈

- **指标**：系统（QPS/延迟/错误）、AI（准确/幻觉/HITL）、成本（Token/GPU/调用）、合规（PHI 访问、审计覆盖）  
- **平台**：Prometheus/Grafana、ELK、OTel/Jaeger、成本看板  
- **告警**：SLO 违约、幻觉率/成本超阈、外部 API 异常  
- **自愈**：健康检查、HPA、熔断/退避重试、备份模型降级、队列背压  
- **演练**：Chaos/故障注入、Runbook

---

## 9. 安全与合规

- **最小必要 & 知情同意**；**传输/存储加密**（TLS/KMS/HSM）  
- **RBAC/ABAC** 与细粒度审计；**密钥轮换**  
- **PII/PHI 脱敏策略** 与数据分级；**跨境合规**（PIPL/GDPR/HIPAA/BAA）  
- **第三方模型**：不落盘、数据不用于训练、专线/私有连接  
- **留存**：日志与审计保留期、WORM/存证（可选区块链哈希）

---

## 10. 实施路线（PoC → MVP → Prod）

### T0（0–8 周，PoC）
- 代表链路：“医生自由问答 → 结构化要点 → 合规化输出 → HITL → 回流”  
- 落地：Temporal 端到端、LLM Proxy、RAG 引注、Tiptap 审核台、三看板雏形  
- 目标：修改率 ≤ 50%，事实错 ≤ 10%，P95 ≤ 5s

### T1（9–20 周，MVP）
- 扩两类意图（文书/用药解读），上线私有化 7B–13B 常驻  
- 多租户（Schema 模式）、审计全覆盖  
- 目标：修改率 ≤ 35%，事实错 ≤ 5%，幻觉 ≤ 3%，成本 ↓ 20%

### T2（21–32 周，Production）
- 高保租户 DB-per-tenant + BYOK  
- 可视化编排（若触发条件达标）  
- 目标：SLA 99.9%，端到端 ≤ 45s，合规 0 事故

---

## 11. 选型矩阵（摘要）

### 11.1 工作流（主：Temporal）
| 指标 | Temporal（主） | Airflow（批） | Camunda/Conductor（存异位） |
|---|---|---|---|
| 场景 | 实时交互、长流程、补偿 | 批/ETL/索引 | 业务自助可视化、复杂审批/大规模可视化运营 |
| 优势 | 强一致、代码即流程、重试补偿 | 生态成熟、Python DAG | 可视化强、运营面板完善 |
| 风险 | 可视化弱/需开发 DSL | 实时性弱 | 新栈学习/部署复杂 |
| 触发 | 默认 | 数据作业 | 当“自助改流程需求高/强运营视图” |

### 11.2 模型与路由（混合）
| 任务 | 模型层级（优先） | 质量/成本守门 | 降级 |
|---|---|---|---|
| 结构化抽取 | 规则/小模型 → 本地中型 | 准确率阈值、耗时阈值 | 规则/缓存 |
| 医生问答 | 本地中型 → 云高阶 | 引注齐备、判别通过 | 本地备份 |
| 复杂文书 | 云高阶 → 本地中型 | 幻觉<阈、HITL通过 | 分段/模板化 |
| 用药建议 | 本地中型 → 云高阶 | 药典核验、红旗词 | 强制 HITL |

---

## 12. 最低落地包（两周内交付）

1. **端到端样例链路**：Temporal 流程（含 User Task）、RAG 引注、HITL 编辑器、合规日志  
2. **LLM Proxy & 路由矩阵**：按“数据分级 × 任务难度 × 成本阈值”  
3. **三看板**：系统性能、AI 质量（幻觉/审阅率/事实错）、成本（Token/GPU）  
4. **多租户骨架**：Schema-per-tenant + 高保客户 DB-per-tenant 样例 + BYOK 流程  
5. **合规清单与审计 Schema（FHIR 元数据）**：模型版本/证据ID/置信度/签批链

---

## 13. 仍保留的选项开关（里程碑评审时决策）

- **BPMN/Conductor 引入**：当“月 > 10 次业务侧自助改流程”或“> 5 位非技术编辑者”或“需要强运营视图”时开启  
- **云 API 配额扩大**：当“质量显著提升且去标识+不落盘可达标”，且“成本/延迟在阈内”  
- **自研/微调升级**：当“HITL 修改率在 2 个迭代难以下降”或“子域问答准确卡在阈值”时，启动专用模型微调

---

## 14. 规则片段（可直接落库/DSL 示例）

```pseudo
# HITL 触发
if intent in ['诊断建议','处方调整'] 
   or uncertainty > 0.4 
   or missing_citations 
   or red_flags:
    USER_TASK('临床复核', sla='24h', escalate='科主任')

# 模型降级/切换
if latency_p95 > 5s or cost_per_1k > THRESH or hallucination_rate > THRESH:
    route.switch(model_tier - 1)

# 审计元数据（入 FHIR 扩展/治理仓）
audit = {
  request_id, tenant_id, model_name, model_version,
  prompt_hash, citations[], confidence, reviewer_id,
  sign_hash, output_hash, timestamp
}
